# NFT 市场通用业务流程（Aptos 生态适用）

本文描述 NFT 市场从“创作者上架 — 买家成交 — 结算拆分 — 索引更新”的端到端业务逻辑，并覆盖一口价、报价、拍卖三类常见路径。

## 流程图

```mermaid
flowchart TD
    A[连接钱包/授权\nConnect wallet & approvals] --> B{用户角色}
    B -->|创作者| C[准备素材与元数据\n上传到 IPFS/Arweave/自托管]
    C --> D[Mint NFT 或 Lazy Mint\n调用NFT合约/签名占位]
    D --> E[选择上架方式\n一口价/报价可接受/拍卖/Launchpad]
    E --> F[签名或上链创建订单\n(授权市场合约可转移/结算)]
    F --> G[市场索引器监听事件/订单\n写入搜索与行情数据库]

    B -->|买家| H[浏览/检索/筛选/稀有度/活动页]
    H --> I{购买方式?}
    I -->|一口价| J[发起购买交易\nBuy Now]
    I -->|报价| K[提交链上或链下报价\n签名订单/挂单]
    I -->|拍卖| L[出价竞拍\n最小加价/反狙击延时]

    K --> K2{卖家是否接受?}
    K2 -->|是| J
    K2 -->|否| H

    L --> L2{到达结束条件?}
    L2 -->|是(最高出价者胜出)| J
    L2 -->|否| L

    J --> M[交易上链/撮合\n校验订单有效性&余额&授权]
    M --> N[合约结算拆分\n平台费+版税+卖家收入]
    N --> O[NFT所有权转移给买家\n或释放托管NFT/资金]
    O --> P[链上事件触发]
    P --> Q[索引器更新列表/地板价/成交记录]
    Q --> R[通知与分析\n消息推送/排行榜/推荐/风控]
    R --> S[订单闭环\n评价/再次转售/资金提现]

    %% 辅助与风控
    subgraph Off-chain/Infra
      G
      Q
      R
      T[风控与合规模块\n洗交易检测/黑名单/反女巫]
      U[图片与元数据缓存\nCDN/缩略图/元数据冻结]
      V[搜索与推荐\n地板价缓存/稀有度计算/聚合]
    end
    P --> T
    C --> U
    H --> V
```

## 关键说明（精简版）

- 上架与订单
  - 一口价（Fixed-price）：最简单，买家直接以定价成交。
  - 报价（Offer）：买家签名意向单（可链下存储），卖家接受后再上链结算。
  - 拍卖（Auction）：常见英式/荷兰式；需处理最小加价、反狙击延时、可选保证金等。
- 资产与结算
  - 托管 vs 非托管：托管为上架即转入市场合约，非托管为成交时在授权下转移。
  - 分账：平台费、创作者版税、卖家净收入按比例自动分配。
- 索引与搜索
  - 监听合约事件驱动列表、地板价、成交历史与稀有度更新与缓存。
- 风控与合规
  - 洗交易识别、黑名单、反女巫；签名防重放；防抢跑/MEV（私有交易、延时）。

## 渲染方式（任选其一）
- GitHub：把上述代码块粘贴进 README.md 或 docs/Flow.md，提交后网页自动渲染。
- 在线：使用 Mermaid Live Editor（https://mermaid.live）粘贴代码即时预览并导出图片。
- VS Code：安装 “Markdown Preview Mermaid Support” 或 “Markdown Preview Enhanced” 插件本地预览。
